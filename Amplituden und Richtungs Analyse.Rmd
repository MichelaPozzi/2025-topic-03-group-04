---
title: "Nochmal"
author: "Nora Otic"
date: "2025-06-09"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
```{r}
#RDS-Daten laden
normalized_ctrl_df <- readRDS("data/normalized_ctrl_df.rds")

str(normalized_ctrl_df)

summary(normalized_ctrl_df)

# Nur erzeugen, wenn Datei noch nicht existiert
if (!file.exists("data/normalized_ctrl_df.rds")) {
  message("HAAALT!!!! Speicher erst neuen Datensatz")
  
  final_data <- data.frame(
    normalized_ctrl_df
  )
  
  saveRDS(final_data, "data/normalized_ctrl_df.rds")
} else {
  message("Datensatz existiert bereits")
}
```

```{r}
normalized_rnase_df <- readRDS("data/normalized_rnase_df.rds")
str(normalized_rnase_df)
summary(normalized_rnase_df)

if (!file.exists("data/normalized_rnase_df.rds")) {
  message("HAAALT!!!! Speicher erst neuen Datensatz")
  
  final_data <- data.frame(
    normalized_rnase_df
  )
  
  saveRDS(final_data, "data/normalized_rnase_df.rds")
} else {
  message("Datensatz existiert bereits")
}
```
##Als Referenz Proteine wurden folgende ermittelt: ?? PLIN3, IGF1R,
#RNA-abhängig: RBM15_HUMAN, HNRDL_HUMAN, ELAV1_HUMAN, DIC_HUMAN, ARGL1_HUMAN (indirekt abhängig), FUS_HUMAN, DDX20_HUMAN, SFPQ_HUMAN, ROA3_HUMAN, ZFR_HUMAN, CIRBP_HUMAN (Alles nachgewiesene RBPs und in R-DeeP gelistet)
#RNA-unabhängig: ATP5L_HUMAN, GAPD1_HUMAN, GPT_HUMAN, COX7R_HUMAN, CYC_HUMAN, IDH3A_HUMAN, UTRO_HUMAN, TPSN_HUMAN, CPT2_HUMAN, LTOR1_HUMAN
# ->(Die als unabhängig definierten Proteine wurden in R-Deep als nicht RBPs gelistet und mit RNAIntra auf Interaktionen mit verschiedenen RNAs geprüft, unter Berücksichtigung ihrer Funktio und Lokalisation wurden sie von uns als negativ Kontrollen für RNA-unabhängige Proteine eingestuft)


## Mittelmäßig bedachte und ausdifferenzierte Vorschläge für fortlaufende Analysen
# Annahme 1: Wir haben alle peaks und die globalen Maxima
```{r}
## Distanz und Richtung der peak-Verschiebung: to be discussed

## Amplitude der globalen Maxima
#find global maxima
find_global_maxima <- function(x, threshold = 2) {
  max_val <- max(x)
  if (max_val >= threshold) {
    which(x == max_val)
  } else {
    integer(0)  # keine Maxima, falls max < threshold
  }
}

process_df_global_maxima <- function(df, threshold = 2) {
  results <- lapply(1:nrow(df), function(i) {
    intensities <- as.numeric(df[i, 2:26])
    protein <- df[i, 1]
    maxima <- find_global_maxima(intensities, threshold)
    list(Protein = protein, Global_Maxima = maxima)
  })
  
  df_maxima <- data.frame(
    Protein = sapply(results, `[[`, "Protein"),
    Global_Maximum = sapply(results, function(x) {
      if (length(x$Global_Maxima) == 0) {
        NA_character_
      } else {
        paste(x$Global_Maxima, collapse = ",")
      }
    }),
    stringsAsFactors = FALSE
  )
  
  return(df_maxima)
}

#apply to dataframes
global_ctrl <- process_df_global_maxima(normalized_ctrl_df, threshold =2)
global_rnase <- process_df_global_maxima(normalized_rnase_df, threshold =2)

head(global_ctrl)
```
```{r}
get_global_amplitudes <- function(expression_df, global_ctrl) {
  amplitudes <- mapply(function(row_idx, max_pos_str) {
    # max_pos_str kann mehrere Maxima enthalten, z.B. "5,10"
    max_positions <- as.numeric(unlist(strsplit(max_pos_str, ",")))
    
    if (length(max_positions) == 0 || all(is.na(max_positions))) {
      return(NA)
    }
    
    # Intensitäten an den Maxima (Achtung: +1 wegen Proteinspalte in expression_df)
    intensities <- as.numeric(expression_df[row_idx, max_positions + 1])
    
    # Falls mehrere Maxima, alle Werte als String mit Komma trennen
    paste(intensities, collapse = ",")
  },
  row_idx = 1:nrow(expression_df),
  max_pos_str = global_ctrl$Global_Maximum
  )
  
  data.frame(
    Protein = expression_df[[1]],
    Amplitudes = amplitudes,
    stringsAsFactors = FALSE
  )
}

global_amplitudes_ctrl <- get_global_amplitudes(normalized_ctrl_df, global_ctrl)

head(global_amplitudes_ctrl)

```
```{r}
get_global_amplitudes <- function(expression_df, global_rnase) {
  amplitudes <- mapply(function(row_idx, max_pos_str) {
    # max_pos_str kann mehrere Maxima enthalten, z.B. "5,10"
    max_positions <- as.numeric(unlist(strsplit(max_pos_str, ",")))
    
    if (length(max_positions) == 0 || all(is.na(max_positions))) {
      return(NA)
    }
    
    # Intensitäten an den Maxima (Achtung: +1 wegen Proteinspalte in expression_df)
    intensities <- as.numeric(expression_df[row_idx, max_positions + 1])
    
    # Falls mehrere Maxima, alle Werte als String mit Komma trennen
    paste(intensities, collapse = ",")
  },
  row_idx = 1:nrow(expression_df),
  max_pos_str = global_rnase$Global_Maximum
  )
  
  data.frame(
    Protein = expression_df[[1]],
    Amplitudes = amplitudes,
    stringsAsFactors = FALSE
  )
}

global_amplitudes_rnase <- get_global_amplitudes(normalized_rnase_df, global_rnase)

head(global_amplitudes_rnase)

```



```{r}
##Gain and loss of amplitude in peak 
# Erst numerisch machen
global_amplitudes_ctrl$Amplitude <- as.numeric(as.character(global_amplitudes_ctrl$Amplitude))
global_amplitudes_rnase$Amplitude <- as.numeric(as.character(global_amplitudes_rnase$Amplitude))

# Verlust: Abnahme der Amplitude nach RNase-Behandlung 
amplitude_loss <- pmax(global_amplitudes_ctrl$Amplitude - global_amplitudes_rnase$Amplitude, 0)

# Zuwachs: Zunahme der Amplitude nach RNase-Behandlung
amplitude_gain <- pmax(global_amplitudes_rnase$Amplitude - global_amplitudes_ctrl$Amplitude, 0)

amplitude_changes <- data.frame(
  Protein = global_amplitudes_ctrl$Protein,
  Amplitude_Control = global_amplitudes_ctrl$Amplitude,
  Amplitude_RNase = global_amplitudes_rnase$Amplitude,
  loss = amplitude_loss,
  gain = amplitude_gain
)

head(amplitude_changes)
```
```{r}
global_ctrl$Global_Maximum <- as.numeric(as.character(global_ctrl$Global_Maximum))
global_rnase$Global_Maximum <- as.numeric(as.character(global_rnase$Global_Maximum))

shift_distance <- global_rnase$Global_Maximum - global_ctrl$Global_Maximum

# Richtung bestimmen
shift_direction <- ifelse(shift_distance > 0, "right shift",
                    ifelse(shift_distance < 0, "left shift",
                           "No Shift"))

# Ergebnis zusammenfassen
shift_result <- data.frame(
  Protein = global_ctrl$Protein,
  Position_Control = global_ctrl$Global_Maximum,
  Position_RNase = global_rnase$Global_Maximum,
  Shift_Distance = shift_distance,
  Shift_Direction = shift_direction
)

head(shift_result)
```



