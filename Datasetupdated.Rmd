---
title: "Untitled"
output: html_document
date: "2025-05-26"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:



```{r}
#load dataset
url <- "https://hub.dkfz.de/s/QT3BfRperQqMxPF/download/RDeeP_A549_NS.csv.zip"


#Create a temporary file and download the ZIP
temp_file <- tempfile()
download.file(url, temp_file)
zip_contents <- unzip(temp_file, list = TRUE)
print(zip_contents)

csv_file <- unzip(temp_file, files = zip_contents$Name[1], exdir = tempdir())
A549_NS <- read.csv(csv_file, sep = ";")
View(A549_NS)
```

```{r}
#data exploration
View(A549_NS)

#number of rows and columns
nrow(A549_NS)
ncol(A549_NS)

#type of data (überprüft die class der Spalten -> alle Eintrage haben zwangsweise dieselbe class)
sum(sapply(A549_NS, is.numeric))

#finding NAs
sum(is.na(A549_NS))
```

##Data cleanup##
```{r}
#definition of general parameters
n_fractions <- 25
n_replicates <- 6

# treatment: variating CTRL and RNAse, 75 pairs -> 150 columns 
treatment <- factor(rep(c("CTRL", "RNASE"), times = n_fractions * n_replicates/2))
# replicates: 6 replicates per fraction
replicates <- factor(c("ctrl1","rnase1","ctrl2","rnase2","ctrl3","rnase3"))
replicates <- factor(rep(replicates, times = n_fractions))
# fraction: each fraction has 6 values
fraction <- factor(rep(paste0("fraction",1:n_fractions),each = n_replicates)) 

```

```{r}
#dataframe definition
df <- data.frame(
  row.names = colnames(A549_NS)[colnames(A549_NS) != "Protein_Name"], 
  treatment = treatment, 
  replicates = replicates, 
  fraction = fraction)

#depict result
head(df)
```

```{r}
#sorting loop by fraction
# define fraction names
fraction_names <- levels(fraction)

# create subtables
tables_by_fraction <- lapply(fraction_names, function(fx) {
  # select all colnames in A549_NS, which belong to a certain fraction
  cols <- rownames(df)[df$fraction == fx]

  #separate control and RNase sample within the subtable (grep-function searches for the word "Ctrl" or "RNase among the columnnames -> generally searches for textpatterns in vectors)
  ctrl_cols <- grep("Ctrl",cols, value = TRUE)
  RNase_cols <- grep("RNase",cols, value = TRUE)
  
  ordered_cols <- c(ctrl_cols, RNase_cols)

  
  # extract the said columns + Protein_Name
  subdf <- A549_NS[, c("Protein_Name", ordered_cols)]
  
})

# assign names to the subtables -> names of fractions are assigned to the different subtables in chronological order
names(tables_by_fraction) <- fraction_names

#depict result
head(tables_by_fraction$fraction1)
class(tables_by_fraction$fraction1)

```

```{r}
#facilitates access to different fractions
df_list <- list()

for (a in 1:25) {
  df_list[[a]] <- as.data.frame(tables_by_fraction[[paste0("fraction", a)]])
}

#depict result
head(df_list[[1]])
class(df_list[[1]])

```

```{r}
#sorting loop by condition

#define all column names
col_names <- colnames(A549_NS)

#select all columns that contain "Ctrl"
ctrl_cols <- grep("Ctrl", col_names, value = TRUE)
df_ctrl <- A549_NS[, c("Protein_Name", ctrl_cols), drop = FALSE]

#select all columns that contain "RNase"
rnase_cols <- grep("RNase", col_names, value = TRUE)
df_rnase <- A549_NS[, c("Protein_Name", rnase_cols), drop = FALSE]

#depict results
head(df_ctrl)
head(df_rnase)
```


```{r}
#create separate sublists for Ctrl and RNase per fraction and computes columnwise means

ctrl_list <- list()
rnase_list <- list()

for (r in 1:25) {
  
  # defines access to the different fractions 
  df <- df_list[[r]]  
  # only takes numeric columns into account
  numeric_df <- df[, sapply(df, is.numeric)] 
  # computes averages by. column
  avg_vector <- colMeans(numeric_df)
  # transform result to dataframe
  avg_df <- as.data.frame(t(avg_vector))
  
  # adds column with fraction name
  fraction_label <- paste0("fraction", r)
  
  # creates separate dataframes for Ctrl and RNase per Fraktion
  ctrl_df <- avg_df[, 1:3]  # Crtl replicates make up the first three columns of avg_df
  ctrl_df$fraction <- fraction_label
  
  rnase_df <- avg_df[, 4:6]  # RNase makes up columns 4 to 6
  rnase_df$fraction <- fraction_label
  
  # rename columns
  colnames(ctrl_df) <- c("Mean_CTRL1", "Mean_CTRL2", "Mean_CTRL3", "fraction")
  colnames(rnase_df) <- c("Mean_RNASE1", "Mean_RNASE2", "Mean_RNASE3", "fraction")
  
  # save columns in respective lists
  ctrl_list[[r]] <- ctrl_df
  rnase_list[[r]] <- rnase_df
}

# create to dataframes which contain the averages for all fractions
ctrl_combined <- do.call(rbind, ctrl_list)
rnase_combined <- do.call(rbind, rnase_list)

# depict result
head(ctrl_combined)
head(rnase_combined)

```

```{r}
# determine the mean of the two closest replicate means

# function: mean of the two closest means (of 3 means per treatment)
mean_of_closest_pair <- function(x) {
  combs <- combn(x, 2)
  diffs <- abs(combs[1, ] - combs[2, ])
  min_idx <- which.min(diffs)
  mean(combs[, min_idx])
}

# initialize result vectors
final_means_control <- numeric(n_fractions)
final_means_rnase <- numeric(n_fractions)

# loop over all 25 fractions
for (r in 1:n_fractions) {
  
  # access replicate means of control and RNase
  control_values <- as.numeric(ctrl_combined[r, 1:3])
  rnase_values   <- as.numeric(rnase_combined[r, 1:3])
  
  # compution of the final means
  final_means_control[r] <- mean_of_closest_pair(control_values)
  final_means_rnase[r]   <- mean_of_closest_pair(rnase_values)
}
# generate a dataframe with both treatment means per fraction
  final_means_df <- data.frame(
  fraction = 1:length(final_means_control),
  control_mean = final_means_control,
  rnase_mean = final_means_rnase)

# depict results/dataframe 
head(final_means_control)
head(final_means_rnase)
head(final_means_df)

```

```{r}
# compute normalization vectors for each replicate

# number of fractions and replicates
n_fractions <- 25
n_replicates <- 3

# initialize matrizes for saving the normalizationfacotrs 
norm_ctrl_mat <- matrix(NA, nrow = n_fractions, ncol = n_replicates)
norm_rnase_mat <- matrix(NA, nrow = n_fractions, ncol = n_replicates)

# loop over all fractions
for (r in 1:n_fractions) {
  # extract values of the replicates
  control_values <- as.numeric(ctrl_combined[r, 1:3])
  rnase_values   <- as.numeric(rnase_combined[r, 1:3])
  
  # define final_means of the treatments
  mean_control <- final_means_control[r]
  mean_rnase   <- final_means_rnase[r]
  
  # compute normalization factors
  norm_ctrl_mat[r, ] <- control_values / mean_control
  norm_rnase_mat[r, ] <- rnase_values / mean_rnase
}

# create vectors for each replicate
norm.ctrl1 <- norm_ctrl_mat[, 1]
norm.ctrl2 <- norm_ctrl_mat[, 2]
norm.ctrl3 <- norm_ctrl_mat[, 3]

norm.rnase1 <- norm_rnase_mat[, 1]
norm.rnase2 <- norm_rnase_mat[, 2]
norm.rnase3 <- norm_rnase_mat[, 3]

```

```{r}
# depict results
head(norm.ctrl1)
head(norm.ctrl2)
head(norm.ctrl3)
head(norm.rnase1)
head(norm.rnase2)
head(norm.rnase3)

length(norm.ctrl1)
```


```{r}
# normalization of the data per replicate & fraction

# initialize empty lists for the normalized tables
norm_ctrl_list <- list()
norm_rnase_list <- list()

# loop over all fractions
for (r in 1:n_fractions) {
  
  # use only the first three columns of the dataframes (the last   column contains rownames)
  ctrl_df <- ctrl_combined[r, 1:3] ####müssten Originaldaten sein!!!!!!!
  rnase_df <- rnase_combined[r, 1:3]
  
  # get the corresponding normalization factors for each fraction
  norm_factors_ctrl <- norm_ctrl_mat[r, ]
  norm_factors_rnase <- norm_rnase_mat[r, ]
  
  # apply normalization
  norm_ctrl <- as.data.frame(mapply(`*`, ctrl_df, norm_factors_ctrl, SIMPLIFY = FALSE))
  norm_rnase <- as.data.frame(mapply(`*`, rnase_df, norm_factors_rnase, SIMPLIFY = FALSE))
  
  # save in lists
  norm_ctrl_list[[r]] <- norm_ctrl
  norm_rnase_list[[r]] <- norm_rnase
}

# optional: combine to one df per treatment
norm_ctrl_combined <- do.call(rbind, norm_ctrl_list)
norm_rnase_combined <- do.call(rbind, norm_rnase_list)

# depict result
head(norm_ctrl_combined)
head(norm_rnase_combined)

```

```{r}
#meanfilter 

#define function to compute meanfilter
mean_filter <- function(x) {
  n <- nrow(norm_ctrl_combined)
  y <- numeric(n)
  y[1] <- x[1] #value for fraction1 will not be changed
  y[n] <- x[n] #value for fraction25 will not be changed
  
  for (i in 2:(n - 1)) {
    y[i] <- mean(x[(i - 1):(i + 1)]) 
  }
  return(y)
}

#apply to normalized dataframes
# transposes dataframes as meanfilter works on columns not on rows
t_norm_ctrl <- t(norm_ctrl_combined)
t_norm_rnase <- t(norm_rnase_combined)

#execute meanfilter
ctrl_filtered <- as.data.frame(apply(t_norm_ctrl, 1, mean_filter))
rnase_filtered <- as.data.frame(apply(t_norm_rnase, 1, mean_filter))

# restores column and row names
colnames(ctrl_filtered) <- colnames(norm_ctrl_combined)
colnames(rnase_filtered) <- colnames(norm_rnase_combined)
rownames(ctrl_filtered) <- rownames(norm_ctrl_combined)
rownames(rnase_filtered) <- rownames(norm_rnase_combined)

#depict result
head(ctrl_filtered)
head(rnase_filtered)

```

```{r}
#normalize total amount per replicate to 100%
normalized_cols <- function(df) {
  df_norm <- df  # creates copy

  # selects all cols 
  col_range <- 1:length(ctrl_filtered)

  # set amount to sum = 100% for each column
  for (j in col_range) {
    col_sum <- sum(df[[j]])
    if (col_sum != 0) {
      df_norm[[j]] <- (df[[j]] / col_sum * 100)
    } else {
      df_norm[[j]] <- 0  # oder NA
    }
  }
  return(df_norm)
}

# apply to filtered dataframes
ctrl_norm_percent <- normalized_cols(ctrl_filtered)
rnase_norm_percent <- normalized_cols(rnase_filtered)

#depict result
head(ctrl_norm_percent)
head(rnase_norm_percent)

#check if sums equal 100
colSums(ctrl_norm_percent)  
colSums(rnase_norm_percent)


```

```{r}
#compute average of replicates per fraction

ctrl_avg <- rowMeans(ctrl_norm_percent)
rnase_avg <- rowMeans(rnase_norm_percent)

#combine Ctrl and RNase result
avg_fractions <- cbind(ctrl_avg, rnase_avg)
avg_fractions_df <- as.data.frame(avg_fractions)

#rename rows and columns
colnames(avg_fractions_df) <- c("Average Ctrl", "Average Rnase")
rownames(avg_fractions_df) <- fraction_names

#depict result
View(avg_fractions_df)
```

```{r}
#normalize total amount per condition to 100%
normalized_cols <- function(df) {
  df_norm <- df  # creates copy

  # selects all cols 
  col_range <- 1:length(ctrl_filtered)

  # set amount to sum = 100% for each column
  for (j in col_range) {
    col_sum <- sum(df[[j]])
    if (col_sum != 0) {
      df_norm[[j]] <- (df[[j]] / col_sum * 100)
    } else {
      df_norm[[j]] <- 0  # oder NA
    }
  }
  return(df_norm)
}

# apply to filtered dataframes
ctrl_norm_percent <- normalized_cols(ctrl_filtered)
rnase_norm_percent <- normalized_cols(rnase_filtered)

#depict result
head(ctrl_norm_percent)
head(rnase_norm_percent)

#check if sums equal 100
colSums(ctrl_norm_percent)  
colSums(rnase_norm_percent)

```


```{r}
#reproducability 
#geordnete Tabelle

length(tables_by_fraction)
print(tables_by_fraction)
protein_names <- tables_by_fraction[[1]]$Protein_Name
table_list_no_names <- lapply(tables_by_fraction, function(x) x[, -1])

# Spaltenweise zusammenfügen
ordered_table <- do.call(cbind, table_list_no_names)

# Protein_Name wieder hinzufügen
ordered_table <- cbind(Protein_Name = protein_names, ordered_table)
ordered_table <- as.data.frame(ordered_table, check.names = FALSE)
print(ordered_table)

```

```{r}
ctrl_correlations <- data.frame(
  fraction = character(),
  ctrl1_vs_ctrl2 = numeric(),
  ctrl1_vs_ctrl3 = numeric(),
  ctrl2_vs_ctrl3 = numeric(),
  stringsAsFactors = FALSE
)

# Schleife über alle 25 Fraktionen
for (i in 0:24) {
  start_col <- 2 + i * 6 
  end_col <- start_col + 2
  ctrl_data <- ordered_table[, start_col:end_col]
  colnames(ctrl_data) <- c("ctrl1", "ctrl2", "ctrl3")
  cor_matrix <- cor(ctrl_data, use = "pairwise.complete.obs", method = "pearson")
  ctrl_correlations <- rbind(ctrl_correlations, data.frame(
    fraction = paste0("fraction", i + 1),
    ctrl1_vs_ctrl2 = cor_matrix["ctrl1", "ctrl2"],
    ctrl1_vs_ctrl3 = cor_matrix["ctrl1", "ctrl3"],
    ctrl2_vs_ctrl3 = cor_matrix["ctrl2", "ctrl3"]
  ))
}

# Ergebnis ansehen
View(ctrl_correlations)
plot(ctrl_correlations) ####Richtig so????
```

```{r}
##nochmal mit RNase Korrelation

rnase_correlations <- data.frame(
  fraction = character(),
  rnase1_vs_rnase2 = numeric(),
  rnase1_vs_rnase3 = numeric(),
  rnase2_vs_rnase3 = numeric(),
  stringsAsFactors = FALSE
)

# Schleife über alle 25 Fraktionen
for (i in 0:24) {
  start_col <- 2 + i * 6 
  end_col <- start_col + 2
  rnase_data <- ordered_table[, start_col:end_col]
  colnames(rnase_data) <- c("rnase1", "rnase2", "rnase3")
  cor_matrix <- cor(rnase_data, use = "pairwise.complete.obs", method = "pearson")
  rnase_correlations <- rbind(rnase_correlations, data.frame(
    fraction = paste0("fraction", i + 1),
    rnase1_vs_rnase2 = cor_matrix["rnase1", "rnase2"],
    rnase1_vs_rnase3 = cor_matrix["rnase1", "rnase3"],
    rnase2_vs_rnase3 = cor_matrix["rnase2", "rnase3"]
  ))
}

View(rnase_correlations)
```
